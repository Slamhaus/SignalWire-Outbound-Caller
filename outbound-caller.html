<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignalWire Outbound Caller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { margin-top: 30px; }
        .call-controls { margin-top: 20px; }
        .status-display { margin-top: 15px; }
        .config-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        #callStatus { min-height: 40px; }
        .form-label { font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <h1 class="text-center mb-4">SignalWire Outbound Caller</h1>
                
                <!-- Configuration Section -->
                <div class="config-section">
                    <h3>Configuration</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="projectId" class="form-label">Project ID</label>
                                <input type="text" class="form-control" id="projectId" placeholder="Enter your SignalWire Project ID">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="spaceName" class="form-label">Space Name</label>
                                <input type="text" class="form-control" id="spaceName" placeholder="yourspace.signalwire.com">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="apiToken" class="form-label">API Token</label>
                                <input type="password" class="form-control" id="apiToken" placeholder="Enter your SignalWire Token">
                            </div>
                        </div>
                    </div>
                    <button id="connectBtn" class="btn btn-primary">Connect to SignalWire</button>
                    <button id="disconnectBtn" class="btn btn-outline-danger ms-2 d-none">Disconnect</button>
                    <div id="connectionStatus" class="status-display"></div>
                </div>

                <!-- Call Section -->
                <div class="card">
                    <div class="card-header">
                        <h3>Make Outbound Call</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="phoneNumber" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phoneNumber" placeholder="+1234567890" required>
                                </div>
                            </div>
                        </div>

                        <div class="call-controls">
                            <button id="callBtn" class="btn btn-success btn-lg" disabled>
                                <span class="spinner-border spinner-border-sm d-none me-2"></span>
                                Call
                            </button>
                            <button id="hangupBtn" class="btn btn-danger btn-lg d-none">Hang Up</button>
                        </div>
                        
                        <div id="callStatus" class="alert d-none mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.signalwire.com/@signalwire/js"></script>
    <script>
        class SignalWireOutboundCaller {
            constructor() {
                this.client = null;
                this.currentCall = null;
                this.isConnected = false;
                
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('connectBtn').addEventListener('click', () => this.connectToSignalWire());
                document.getElementById('disconnectBtn').addEventListener('click', () => this.disconnectFromSignalWire());
                document.getElementById('callBtn').addEventListener('click', () => this.makeCall());
                document.getElementById('hangupBtn').addEventListener('click', () => this.hangupCall());
                
                // Format phone number on input
                document.getElementById('phoneNumber').addEventListener('input', this.formatPhoneNumber);
            }

            formatPhoneNumber(event) {
                let value = event.target.value.replace(/\D/g, '');
                if (value.length > 0 && !value.startsWith('1')) {
                    value = '1' + value;
                }
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }
                
                let formatted = '+';
                if (value.length > 0) formatted += value.substring(0, 1);
                if (value.length > 1) formatted += value.substring(1, 4);
                if (value.length > 4) formatted += value.substring(4, 7);
                if (value.length > 7) formatted += value.substring(7, 11);
                
                event.target.value = formatted;
            }

            showStatus(message, type = 'info', persistent = false) {
                const statusElement = document.getElementById('callStatus');
                statusElement.className = `alert alert-${type}`;
                statusElement.textContent = message;
                statusElement.classList.remove('d-none');
                
                if (!persistent) {
                    setTimeout(() => {
                        statusElement.classList.add('d-none');
                    }, 5000);
                }
            }

            showConnectionStatus(message, type = 'info') {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.className = `alert alert-${type} mt-2`;
                statusElement.textContent = message;
            }

            async checkResourceExists() {
                const spaceName = document.getElementById('spaceName').value;
                const projectId = document.getElementById('projectId').value;
                const apiToken = document.getElementById('apiToken').value;

                try {
                    const response = await fetch(`https://${spaceName}/api/fabric/resources`, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Basic ' + btoa(`${projectId}:${apiToken}`)
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to fetch resources: HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Debug: Log all resources to see what we have
                    console.log('All resources:', data.data);
                    
                    // Find resource named "call pstn html" with type "swml_script"
                    const resource = data.data && data.data.find(resource => {
                        console.log(`Checking resource: display_name="${resource.display_name}", type="${resource.type}"`);
                        return resource.display_name === 'call pstn html' && resource.type === 'swml_script';
                    });

                    console.log('Found resource:', resource);
                    return resource ? { exists: true, id: resource.id } : { exists: false, id: null };
                } catch (error) {
                    console.error('Error checking resource:', error);
                    throw error;
                }
            }

            async createSWMLResource() {
                const spaceName = document.getElementById('spaceName').value;
                const projectId = document.getElementById('projectId').value;
                const apiToken = document.getElementById('apiToken').value;

                try {
                    const swmlContent = {
                        "version": "1.0.0",
                        "sections": {
                            "main": [
                                {
                                    "record_call": {
                                        "format": "wav"
                                    }
                                },
                                {
                                    "connect": {
                                        "to": "%{vars.userVariables.destination_number}"
                                    }
                                }
                            ]
                        }
                    };

                    const response = await fetch(`https://${spaceName}/api/fabric/resources/swml_scripts`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Basic ' + btoa(`${projectId}:${apiToken}`)
                        },
                        body: JSON.stringify({
                            name: 'call pstn html',
                            contents: swmlContent
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(`Failed to create SWML resource: HTTP ${response.status}: ${errorData}`);
                    }

                    const data = await response.json();
                    console.log('Created SWML resource response:', data);
                    return { id: data.id };
                } catch (error) {
                    console.error('Error creating SWML resource:', error);
                    throw error;
                }
            }

            async getSWMLScriptAddresses(resourceId) {
                const spaceName = document.getElementById('spaceName').value;
                const projectId = document.getElementById('projectId').value;
                const apiToken = document.getElementById('apiToken').value;

                try {
                    const response = await fetch(`https://${spaceName}/api/fabric/resources/swml_scripts/${resourceId}/addresses`, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Basic ' + btoa(`${projectId}:${apiToken}`)
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to fetch SWML script addresses: HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    return data.data && data.data.length > 0 ? data.data[0].id : null;
                } catch (error) {
                    console.error('Error fetching SWML script addresses:', error);
                    throw error;
                }
            }

            async createGuestToken(allowedAddresses) {
                const spaceName = document.getElementById('spaceName').value;
                const projectId = document.getElementById('projectId').value;
                const apiToken = document.getElementById('apiToken').value;

                try {
                    const response = await fetch(`https://${spaceName}/api/fabric/guests/tokens`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Basic ' + btoa(`${projectId}:${apiToken}`)
                        },
                        body: JSON.stringify({
                            allowed_addresses: allowedAddresses
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(`Failed to create guest token: HTTP ${response.status}: ${errorData}`);
                    }

                    const data = await response.json();
                    return data.token;
                } catch (error) {
                    console.error('Error creating guest token:', error);
                    throw error;
                }
            }

            async connectToSignalWire() {
                try {
                    this.showConnectionStatus('Connecting to SignalWire...', 'info');
                    
                    const connectBtn = document.getElementById('connectBtn');
                    connectBtn.disabled = true;
                    connectBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Connecting...';

                    // Validate required fields
                    const spaceName = document.getElementById('spaceName').value;
                    const projectId = document.getElementById('projectId').value;
                    const apiToken = document.getElementById('apiToken').value;

                    if (!spaceName || !projectId || !apiToken) {
                        throw new Error('Space name, Project ID, and API Token are required');
                    }

                    let resourceId;

                    // Check if SWML resource exists
                    this.showConnectionStatus('Checking SWML resource...', 'info');
                    const resourceCheck = await this.checkResourceExists();
                    
                    if (!resourceCheck.exists) {
                        this.showConnectionStatus('Creating SWML resource...', 'info');
                        const createdResource = await this.createSWMLResource();
                        resourceId = createdResource.id;
                        this.showConnectionStatus('SWML resource created successfully!', 'success');
                    } else {
                        resourceId = resourceCheck.id;
                        this.showConnectionStatus('SWML resource already exists', 'info');
                    }

                    // Get the address UUID for the SWML resource
                    this.showConnectionStatus('Getting resource address...', 'info');
                    const addressId = await this.getSWMLScriptAddresses(resourceId);
                    
                    if (!addressId) {
                        throw new Error('Could not find address for SWML resource');
                    }

                    // Create guest token with the specific address
                    this.showConnectionStatus('Creating guest token...', 'info');
                    const guestToken = await this.createGuestToken([addressId]);

                    // Initialize SignalWire client with guest token
                    this.client = await SignalWire.SignalWire({
                        project: projectId,
                        token: guestToken
                    });

                    this.isConnected = true;
                    
                    this.showConnectionStatus('Connected successfully!', 'success');
                    connectBtn.innerHTML = 'Connected';
                    connectBtn.classList.remove('btn-primary');
                    connectBtn.classList.add('btn-success');
                    
                    // Show disconnect button and hide connect button
                    document.getElementById('disconnectBtn').classList.remove('d-none');
                    connectBtn.classList.add('d-none');
                    
                    // Enable call button
                    document.getElementById('callBtn').disabled = false;
                    
                    console.log('SignalWire client initialized successfully');

                } catch (error) {
                    console.error('Connection error:', error);
                    this.showConnectionStatus(`Connection failed: ${error.message}`, 'danger');
                    
                    const connectBtn = document.getElementById('connectBtn');
                    connectBtn.disabled = false;
                    connectBtn.innerHTML = 'Connect to SignalWire';
                }
            }

            disconnectFromSignalWire() {
                try {
                    // End any active call first
                    if (this.currentCall) {
                        this.hangupCall();
                    }

                    // Clear connection state
                    this.client = null;
                    this.isConnected = false;

                    // Reset UI
                    const connectBtn = document.getElementById('connectBtn');
                    const disconnectBtn = document.getElementById('disconnectBtn');
                    
                    connectBtn.innerHTML = 'Connect to SignalWire';
                    connectBtn.classList.remove('btn-success');
                    connectBtn.classList.add('btn-primary');
                    connectBtn.classList.remove('d-none');
                    connectBtn.disabled = false;
                    
                    disconnectBtn.classList.add('d-none');

                    // Disable call button
                    document.getElementById('callBtn').disabled = true;

                    this.showConnectionStatus('Disconnected from SignalWire', 'info');
                    
                    console.log('Disconnected from SignalWire');
                } catch (error) {
                    console.error('Error during disconnect:', error);
                    this.showConnectionStatus(`Disconnect error: ${error.message}`, 'warning');
                }
            }

            formatPhoneNumberE164(phoneNumber) {
                // Remove all non-digit characters
                const cleaned = phoneNumber.replace(/\D/g, '');
                
                // Add country code if not present
                if (cleaned.length === 10) {
                    return '+1' + cleaned;
                } else if (cleaned.length === 11 && cleaned.startsWith('1')) {
                    return '+' + cleaned;
                }
                
                return phoneNumber; // Return as-is if already formatted or invalid
            }

            async makeCall() {
                if (!this.isConnected || !this.client) {
                    this.showStatus('Please connect to SignalWire first', 'warning');
                    return;
                }

                try {
                    const phoneNumber = document.getElementById('phoneNumber').value;
                    const callResource = '/private/call-pstn-html';

                    if (!phoneNumber) {
                        this.showStatus('Please enter a phone number', 'warning');
                        return;
                    }

                    // Format phone number to E.164
                    const formattedNumber = this.formatPhoneNumberE164(phoneNumber);
                    
                    this.showStatus('Initiating call...', 'info', true);
                    
                    const callBtn = document.getElementById('callBtn');
                    const hangupBtn = document.getElementById('hangupBtn');
                    
                    callBtn.disabled = true;
                    callBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Calling...';

                    // Prepare user variables
                    const userVariables = {
                        destination_number: formattedNumber
                    };

                    // Create the call
                    this.currentCall = await this.client.dial({
                        to: callResource,
                        video: false,
                        audio: true,
                        userVariables: userVariables
                    });

                    // Set up call event handlers
                    this.currentCall.on('destroy', () => {
                        console.log('Call ended');
                        this.handleCallEnd();
                    });

                    this.currentCall.on('state.changed', (state) => {
                        console.log('Call state changed:', state);
                        this.showStatus(`Call state: ${state}`, 'info', true);
                    });

                    // Start the call
                    await this.currentCall.start();
                    
                    this.showStatus('Call connected!', 'success', true);
                    
                    // Update UI
                    callBtn.classList.add('d-none');
                    hangupBtn.classList.remove('d-none');

                } catch (error) {
                    console.error('Error making call:', error);
                    this.showStatus(`Call failed: ${error.message}`, 'danger');
                    this.resetCallUI();
                }
            }

            async hangupCall() {
                if (this.currentCall) {
                    try {
                        await this.currentCall.hangup();
                        this.showStatus('Call ended', 'info');
                    } catch (error) {
                        console.error('Error hanging up call:', error);
                        this.showStatus(`Error ending call: ${error.message}`, 'danger');
                    }
                }
                this.handleCallEnd();
            }

            handleCallEnd() {
                this.currentCall = null;
                this.resetCallUI();
                this.showStatus('Call ended', 'info');
            }

            resetCallUI() {
                const callBtn = document.getElementById('callBtn');
                const hangupBtn = document.getElementById('hangupBtn');
                
                callBtn.disabled = !this.isConnected;
                callBtn.innerHTML = 'Call';
                callBtn.classList.remove('d-none');
                hangupBtn.classList.add('d-none');
            }
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SignalWireOutboundCaller();
        });
    </script>
</body>
</html>
